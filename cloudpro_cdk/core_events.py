import os

from constructs import Construct
from aws_cdk import(
    Stack,
    Duration,
    aws_lambda as lambda_,
    aws_events as events,
    aws_events_targets as targets,
    aws_sqs as sqs
)

class CoreEvents(Stack):
    def __init__(self,scope: Construct,  construct_id: str, ebus_pro:events.EventBus, dynamodb_tables:dict,  **kwargs) -> None:
        super().__init__(scope, construct_id, **kwargs)

        IDENT_PRO_STATE_INIT="custom.lambda.pro.state"
        SOURCE_PRO_STATE_INIT="custom.cloudpro.core"
        SOURCE_PT_COMPLETE_SURVEY="custom.cloudpro.core.survey.complete"
        SOURCE_NOTIFICATIONS="custom.cloudpro.notifications"
        DETAIL_TYPE_PROPACK_STATE_INIT="State Init"
        DETAIL_TYPE_PT_SURVEY_COMPLETE="Survey Completed"
        DETAIL_TYPE_NOTIFICATIONS="New Notification"

        layer_cloudpro_lib = lambda_.LayerVersion.from_layer_version_arn(self,id="layer_cloudpro_lib",layer_version_arn=self.node.try_get_context("layer_arn"))



        fn_pro_state_init = lambda_.Function(
            self,"fn-pro-state-init-dev",
            description="pro-state-init-dev", #microservice tag
            runtime=lambda_.Runtime.PYTHON_3_9,
            handler="index.handler",
            code=lambda_.Code.from_asset(os.path.join("cloudpro_cdk/lambda/pro_state","pro_state_init")),
            environment={
                "IDENTIFIER": IDENT_PRO_STATE_INIT,
                "TABLE_QUESTIONNAIRE":dynamodb_tables["questionnaire"].table_name,
                "TABLE_STATE":dynamodb_tables["state"].table_name,
            },
            layers=[layer_cloudpro_lib]
        )
        # ebus_pro.grant_put_events_to(fn_pro_state_init)
        dynamodb_tables["questionnaire"].grant_read_data(fn_pro_state_init)
        dynamodb_tables["state"].grant_write_data(fn_pro_state_init)

        sqs_propack_state_init_dlq = sqs.Queue(self,"sqs-propack-state-init-dlq-dev")
        rule_propack_init = events.Rule(self, "cdk-rule-propack-state-init-dev",
            description="Rule to initialize a state for a user.",
            event_pattern=events.EventPattern(
                source=[SOURCE_PRO_STATE_INIT],
                detail_type=[DETAIL_TYPE_PROPACK_STATE_INIT]
            ),
            event_bus=ebus_pro
        ) 
        # Rule match: Set target to lambda processor to extract files
        rule_propack_init.add_target(
            targets.LambdaFunction(
                fn_pro_state_init,
                dead_letter_queue=sqs_propack_state_init_dlq,
                max_event_age=Duration.hours(2), 
                retry_attempts=2
            )
        )


        fn_survey_completed = lambda_.Function(
            self,"fn-reporting-survey-completed-dev",
            description="reporting-survey-completed-dev", #microservice tag
            runtime=lambda_.Runtime.PYTHON_3_9,
            handler="index.handler",
            code=lambda_.Code.from_asset(os.path.join("cloudpro_cdk/lambda/ptreporting","reporting_survey_completed")),
            environment={
                "IDENTIFIER": SOURCE_PT_COMPLETE_SURVEY,
                "TABLE_PT_REPORTING":dynamodb_tables["pt_reporting"].table_name,
                "TABLE_AGGREGATES":dynamodb_tables["aggregates"].table_name
            },
            layers=[layer_cloudpro_lib]
        )

        dynamodb_tables["pt_reporting"].grant_read_write_data(fn_survey_completed)
        dynamodb_tables["aggregates"].grant_read_write_data(fn_survey_completed)

        sqs_ptreport_dlq = sqs.Queue(self,"sqs-reporting-survey-complete-dlq-dev")
        rule_ptreport_complete = events.Rule(self, "cdk-rule-reporting-survey-complete-dev",
            description="Survey completed event.",
            event_pattern=events.EventPattern(
                source=[SOURCE_PT_COMPLETE_SURVEY],
                detail_type=[DETAIL_TYPE_PT_SURVEY_COMPLETE]
            ),
            event_bus=ebus_pro
        ) 
        # Rule match: Set target to lambda processor to extract files
        rule_ptreport_complete.add_target(
            targets.LambdaFunction(
                fn_survey_completed,
                dead_letter_queue=sqs_ptreport_dlq,
                max_event_age=Duration.hours(2), 
                retry_attempts=2
            )
        )


        fn_notification_create= lambda_.Function(
            self,"fn-notification-create-dev",
            description="notificatin-create-dev", #microservice tag
            runtime=lambda_.Runtime.PYTHON_3_9,
            handler="index.handler",
            code=lambda_.Code.from_asset(os.path.join("cloudpro_cdk/lambda/notifications","create_notification")),
            environment={
                "IDENTIFIER": SOURCE_NOTIFICATIONS,
                "TABLE_NOTIFICATIONS":dynamodb_tables["notifications"].table_name
            },
            layers=[layer_cloudpro_lib]
        )

        dynamodb_tables["notifications"].grant_read_write_data(fn_notification_create)

        sqs_notification_dlq = sqs.Queue(self,"sqs-notifications-dlq-dev")
        rule_notification_create = events.Rule(self, "cdk-rule-notification-create-dev",
            description="Created notification.",
            event_pattern=events.EventPattern(
                #source=[SOURCE_PT_COMPLETE_SURVEY],
                detail_type=[DETAIL_TYPE_NOTIFICATIONS]
            ),
            event_bus=ebus_pro
        ) 
        # Rule match: Set target to lambda processor to extract files
        rule_notification_create.add_target(
            targets.LambdaFunction(
                fn_notification_create,
                dead_letter_queue=sqs_notification_dlq,
                max_event_age=Duration.hours(2), 
                retry_attempts=2
            )
        )